version: 1.0.{build}
image: Visual Studio 2017
configuration: Release
platform: Any CPU
pull_requests:
  do_not_increment_build_number: true
install:
  - dotnet --info
  - ps: choco install docker-compose
  - ps: choco install nodejs
before_build:
  - dotnet restore Modix.sln
  - 7z a deploy-script.zip before-deploy.ps1
  - cd Modix.Frontend && npm run ci-deploy
build:
  project: Modix.sln
  verbosity: minimal
test: off  
after_build:
  - ps: |
      if(-not [System.String]::IsNullOrWhitespace($env:APPVEYOR_PULL_REQUEST_NUMBER)) {	return; }
      $tag = $env:APPVEYOR_REPO_BRANCH
      if([System.String]::IsNullOrWhitespace($tag)) { $tag = "untagged" }
      docker login -u="$env:DOCKER_USER" -p="$env:DOCKER_PASS"
      docker tag modix cisien/modix:$tag
      docker push cisien/modix:$tag
artifacts:
  - path: deploy-script.zip
    name: deploy-script
deploy:
  - provider: Environment
    name: spartanhost
    on:
      branch: master
environment:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOCKER_USER:
    secure: ry9x9cQ9gzMNaPOd45RSHQ==
  DOCKER_PASS:
    secure: AXXeju7g+0ZE1ZMW2TKcXfW6+CMT70ZDh5iWYE5Bg80=
  ModixToken:
    secure: BWrrOxIXH+Aq+iQLbCR5SUS28lWtWIm/ideML7d5k7oppYgFDN7Kz68SVjUBbLPEv0hV9REAMaRK4vr0Ng8vng==
  ReplServiceToken:
    secure: GroejrzfkoqNfBomrM4kTrBhT9PoueDewcScZe81dYrqU42xc4WRH2gbNib7wDTz
  SOToken:
    secure: ikKVUonT4VkpFzI4GhMi3ZNqHzgA6DokzWXvm0G4DUg=
  log_webhook_token:
    secure: /QjuIMGkGJIDgoyw+zeIsQQKjcbnrmydGAjcOhzYvFPHy2CFoev9vd2Bq8gv+oA/dUVv8mFShqPqvzFq+1PkwdUMIYVB21wcTRENTA4FjjQ=
  ConnectionString:
    secure: 8PVz6xxIRSSmArx6kk/fIh3cDkia6JTOhYsaIctm9cijgBRB9Bsvgv0szpGtzwHzVUw3MeDd28wYCgMZr0abDShhxjIsEOEYMJs1VzSPuXA=
  log_webhook_id: 382609729802862592
  SentryToken:
    secure: TSVcrUaf7lIi4YoOKrZhqrf6MvXh+XFUMO454dwB0q8ieNFOap49KhCYhw4x9sRflgQnDhppjzdbOrFiDnwQvID4rb3nXCxnJRzPLOUwOYlM4SfitMt2LnyGzyOdminq
  DiscordClientId: 279796300210372612
  DiscordClientSecret:
    secure: YdnkxXjIMPdHwqApk3pNZd36EJCnnfDjAldI0OOcBCGd8AfcFvXMy+ygI/it0e9B
  ASPNETCORE_URLS: http://0.0.0.0:8080